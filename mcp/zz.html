<!DOCTYPE html><html lang="es"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Fase 0: Django Auth Setup - Ana Prevention</title>    <style>        * {            margin: 0;            padding: 0;            box-sizing: border-box;        }                body {            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;            line-height: 1.6;            color: #333;            background: #f5f5f5;            padding: 20px;        }                .container {            max-width: 1200px;            margin: 0 auto;            background: white;            padding: 40px;            border-radius: 8px;            box-shadow: 0 2px 8px rgba(0,0,0,0.1);        }                header {            border-bottom: 3px solid #28D196;            padding-bottom: 20px;            margin-bottom: 40px;        }                h1 {            color: #1a1a1a;            font-size: 2.5em;            margin-bottom: 10px;        }                .subtitle {            color: #666;            font-size: 1.2em;        }                h2 {            color: #28D196;            font-size: 1.8em;            margin-top: 40px;            margin-bottom: 20px;            padding-bottom: 10px;            border-bottom: 2px solid #e0e0e0;        }                h3 {            color: #333;            font-size: 1.4em;            margin-top: 30px;            margin-bottom: 15px;        }                h4 {            color: #555;            font-size: 1.2em;            margin-top: 20px;            margin-bottom: 10px;        }                p {            margin-bottom: 15px;        }                ul, ol {            margin-left: 30px;            margin-bottom: 15px;        }                li {            margin-bottom: 8px;        }                pre {            background: #f8f8f8;            border: 1px solid #e0e0e0;            border-radius: 4px;            padding: 15px;            overflow-x: auto;            margin-bottom: 20px;        }                code {            font-family: 'Courier New', Courier, monospace;            font-size: 0.9em;        }                .code-block {            background: #2d2d2d;            color: #f8f8f2;            padding: 20px;            border-radius: 6px;            margin-bottom: 20px;            overflow-x: auto;        }                .code-block code {            color: #f8f8f2;        }                .info-box {            background: #e3f2fd;            border-left: 4px solid #2196F3;            padding: 15px;            margin-bottom: 20px;            border-radius: 4px;        }                .warning-box {            background: #fff3e0;            border-left: 4px solid #ff9800;            padding: 15px;            margin-bottom: 20px;            border-radius: 4px;        }                .success-box {            background: #e8f5e9;            border-left: 4px solid #4caf50;            padding: 15px;            margin-bottom: 20px;            border-radius: 4px;        }                .critical-box {            background: #ffebee;            border-left: 4px solid #f44336;            padding: 15px;            margin-bottom: 20px;            border-radius: 4px;        }                table {            width: 100%;            border-collapse: collapse;            margin-bottom: 20px;        }                th, td {            padding: 12px;            text-align: left;            border: 1px solid #e0e0e0;        }                th {            background: #28D196;            color: white;            font-weight: 600;        }                tr:nth-child(even) {            background: #f9f9f9;        }                .toc {            background: #f8f8f8;            padding: 20px;            border-radius: 6px;            margin-bottom: 30px;        }                .toc h2 {            margin-top: 0;            border-bottom: none;        }                .toc ul {            list-style: none;            margin-left: 0;        }                .toc li {            margin-bottom: 5px;        }                .toc a {            color: #28D196;            text-decoration: none;        }                .toc a:hover {            text-decoration: underline;        }                .emoji {            font-size: 1.2em;        }                .highlight {            background: #fff176;            padding: 2px 4px;            border-radius: 2px;        }                .badge {            display: inline-block;            padding: 4px 8px;            border-radius: 12px;            font-size: 0.85em;            font-weight: 600;            margin-right: 5px;        }                .badge-success {            background: #4caf50;            color: white;        }                .badge-warning {            background: #ff9800;            color: white;        }                .badge-info {            background: #2196F3;            color: white;        }                .badge-critical {            background: #f44336;            color: white;        }    </style></head><body>    <div class="container">        <header>            <h1>üöÄ Fase 0: Django Auth + Multi-tenancy</h1>            <p class="subtitle">Plan de Implementaci√≥n Completo - Ana Prevention SaaS</p>            <p><strong>Fecha:</strong> Febrero 2026 | <strong>Proyecto:</strong> Ana Prevention v2</p>        </header>        <div class="toc">            <h2>üìë Tabla de Contenidos</h2>            <ul>                <li><a href="#resumen">1. Resumen Ejecutivo</a></li>                <li><a href="#decisiones">2. Decisiones Arquitect√≥nicas</a></li>                <li><a href="#bd-legacy">3. An√°lisis Base de Datos Legacy</a></li>                <li><a href="#modelo">4. Modelo de Datos</a></li>                <li><a href="#backend">5. Implementaci√≥n Backend</a></li>                <li><a href="#frontend">6. Implementaci√≥n Frontend</a></li>                <li><a href="#aws">7. Deployment AWS</a></li>                <li><a href="#validacion">8. Validaci√≥n de Subdominios</a></li>                <li><a href="#checklist">9. Checklist de Implementaci√≥n</a></li>            </ul>        </div>        <section id="resumen">            <h2>1. Resumen Ejecutivo</h2>                        <div class="success-box">                <strong>‚úÖ Decisi√≥n Final:</strong> Implementar Django Auth + JWT con arquitectura multi-tenant domain-based            </div>            <h3>Contexto del Proyecto</h3>            <p>Ana Prevention es un SaaS para empresas cl√≠nicas ocupacionales que est√° migrando desde un sistema legacy. El proyecto requiere:</p>            <ul>                <li><strong>Multi-tenancy:</strong> Cada cl√≠nica opera de forma aislada</li>                <li><strong>578 usuarios legacy:</strong> A migrar desde MySQL con ASP.NET Identity hashes</li>                <li><strong>Compliance m√©dico:</strong> HIPAA-ready, datos sensibles</li>                <li><strong>Escalabilidad:</strong> Preparado para cientos de clientes</li>            </ul>            <h3>Stack Tecnol√≥gico</h3>            <table>                <thead>                    <tr>                        <th>Componente</th>                        <th>Tecnolog√≠a</th>                        <th>Versi√≥n</th>                    </tr>                </thead>                <tbody>                    <tr>                        <td>Backend Framework</td>                        <td>Django</td>                        <td>5.2.10</td>                    </tr>                    <tr>                        <td>API Framework</td>                        <td>Django Ninja</td>                        <td>1.5.3</td>                    </tr>                    <tr>                        <td>Multi-tenancy</td>                        <td>django-tenants</td>                        <td>3.9.0</td>                    </tr>                    <tr>                        <td>Authentication</td>                        <td>djangorestframework-simplejwt</td>                        <td>5.3.0</td>                    </tr>                    <tr>                        <td>Database</td>                        <td>PostgreSQL</td>                        <td>15+</td>                    </tr>                    <tr>                        <td>Frontend</td>                        <td>Next.js + React</td>                        <td>14 + 18</td>                    </tr>                </tbody>            </table>        </section>        <section id="decisiones">            <h2>2. Decisiones Arquitect√≥nicas</h2>            <h3>2.1. Django Auth vs. Better Auth vs. Firebase</h3>                        <div class="info-box">                <strong>Decisi√≥n:</strong> Django Auth + SimpleJWT            </div>            <h4>Alternativas Evaluadas:</h4>            <table>                <thead>                    <tr>                        <th>Soluci√≥n</th>                        <th>Ventajas</th>                        <th>Desventajas</th>                        <th>Veredicto</th>                    </tr>                </thead>                <tbody>                    <tr>                        <td><strong>Django Auth</strong></td>                        <td>                            ‚Ä¢ Maduro (18 a√±os)<br>                            ‚Ä¢ Permissions/Groups built-in<br>                            ‚Ä¢ Django Admin funciona<br>                            ‚Ä¢ Migraci√≥n directa desde legacy<br>                            ‚Ä¢ Sin costos adicionales                        </td>                        <td>                            ‚Ä¢ Frontend debe implementar login UI<br>                            ‚Ä¢ No hay hooks preconstruidos                        </td>                        <td><span class="badge badge-success">‚úÖ ELEGIDO</span></td>                    </tr>                    <tr>                        <td><strong>Better Auth</strong></td>                        <td>                            ‚Ä¢ TypeScript nativo<br>                            ‚Ä¢ Self-hosted<br>                            ‚Ä¢ Multi-tenancy built-in<br>                            ‚Ä¢ Hooks React                        </td>                        <td>                            ‚Ä¢ Duplica sistema de auth<br>                            ‚Ä¢ Sincronizaci√≥n compleja<br>                            ‚Ä¢ Django Admin no funciona<br>                            ‚Ä¢ +30% tiempo desarrollo                        </td>                        <td><span class="badge badge-critical">‚ùå Rechazado</span></td>                    </tr>                    <tr>                        <td><strong>Firebase Auth</strong></td>                        <td>                            ‚Ä¢ Setup r√°pido<br>                            ‚Ä¢ OAuth social f√°cil<br>                            ‚Ä¢ Documentaci√≥n excelente                        </td>                        <td>                            ‚Ä¢ Vendor lock-in<br>                            ‚Ä¢ Datos en servidores Google<br>                            ‚Ä¢ Compliance complejo<br>                            ‚Ä¢ Costos recurrentes                        </td>                        <td><span class="badge badge-critical">‚ùå Rechazado</span></td>                    </tr>                </tbody>            </table>            <h3>2.2. SHARED vs. TENANT Users</h3>                        <div class="info-box">                <strong>Decisi√≥n:</strong> TENANT model (users en schema del tenant)            </div>            <h4>Justificaci√≥n:</h4>            <ul>                <li><strong>Aislamiento total:</strong> Cada cl√≠nica tiene sus propios usuarios, 100% aislados</li>                <li><strong>Seguridad:</strong> No hay riesgo de data leak entre tenants</li>                <li><strong>Simplicidad:</strong> User pertenece a UN solo tenant (matching con legacy)</li>                <li><strong>Compliance:</strong> Cumplimiento m√©dico m√°s simple de auditar</li>                <li><strong>Consistency con legacy:</strong> El sistema legacy ya usa este modelo</li>            </ul>            <div class="warning-box">                <strong>‚ö†Ô∏è Implicaci√≥n:</strong> Si un doctor trabaja en m√∫ltiples cl√≠nicas, necesitar√° m√∫ltiples cuentas (una por cl√≠nica). Esto es aceptable para el caso de uso m√©dico.            </div>            <h3>2.3. Domain-based Multi-tenancy</h3>                        <div class="info-box">                <strong>Decisi√≥n:</strong> Cada cl√≠nica tiene su propio subdominio            </div>            <h4>Arquitectura:</h4>            <pre><code>Cl√≠nica Lima:     https://clinica-lima.anaprevention.comCl√≠nica Arequipa: https://clinica-arequipa.anaprevention.comMinera ABC:       https://minera-abc.anaprevention.com</code></pre>            <h4>Ventajas:</h4>            <ul>                <li>‚úÖ <strong>Branding:</strong> Cada empresa tiene su "espacio" propio</li>                <li>‚úÖ <strong>Seguridad:</strong> Aislamiento visual claro</li>                <li>‚úÖ <strong>Compliance:</strong> Mejor para auditor√≠as m√©dicas</li>                <li>‚úÖ <strong>Profesional:</strong> URLs branded por cliente</li>                <li>‚úÖ <strong>Wildcard DNS:</strong> Nuevos clientes funcionan inmediatamente</li>            </ul>        </section>        <section id="bd-legacy">            <h2>3. An√°lisis Base de Datos Legacy</h2>            <h3>3.1. Estructura de Usuarios Legacy</h3>                        <p>La base de datos legacy (MySQL) contiene <strong class="highlight">578 usuarios activos</strong> en la tabla <code>security_users</code>:</p>            <div class="code-block">                <code>security_users (MySQL Legacy)‚îú‚îÄ‚îÄ id (char(36))                          -- UUID‚îú‚îÄ‚îÄ user_type_id (char(36))                -- FK ‚Üí security_user_types (rol)‚îú‚îÄ‚îÄ company_id (char(36))                  -- FK ‚Üí companies (TENANT)‚îú‚îÄ‚îÄ person_id (char(36))                   -- FK ‚Üí persons‚îú‚îÄ‚îÄ user_name (varchar(30))                -- Username/email‚îú‚îÄ‚îÄ password (varchar(200))                -- ASP.NET Identity hash (PBKDF2)‚îú‚îÄ‚îÄ refresh_token (longtext)‚îú‚îÄ‚îÄ refresh_token_expiry_time (datetime)‚îú‚îÄ‚îÄ status (tinyint(1))‚îú‚îÄ‚îÄ is_blocked (tinyint(1))‚îú‚îÄ‚îÄ is_approved (tinyint(1))‚îî‚îÄ‚îÄ full_name (varchar(255))</code>            </div>            <h3>3.2. Tipos de Usuario Legacy</h3>            <ul>                <li>M√©dico Ocupacional</li>                <li>Radiolog√≠a</li>                <li>Neurolog√≠a</li>                <li>Operaciones</li>                <li>Digitaci√≥n y Escaneo</li>                <li>Gerencia</li>                <li>Analista de Datos</li>                <li>BOT (automatizaci√≥n)</li>                <li>Tercero (externos)</li>            </ul>            <h3>3.3. Estrategia de Migraci√≥n</h3>                        <div class="success-box">                <strong>Approach:</strong> Migraci√≥n con validaci√≥n de password legacy en primer login            </div>            <ol>                <li><strong>Migrar usuarios:</strong> Copiar de <code>security_users</code> a Django <code>auth_user</code></li>                <li><strong>Preservar hashes:</strong> Guardar hash ASP.NET temporalmente</li>                <li><strong>Custom hasher:</strong> Django valida con hasher ASP.NET en primer login</li>                <li><strong>Rehash autom√°tico:</strong> En login exitoso, rehash a Django PBKDF2</li>                <li><strong>Transparente:</strong> Usuario no nota diferencia</li>            </ol>        </section>        <section id="modelo">            <h2>4. Modelo de Datos</h2>            <h3>4.1. SystemUser Model</h3>                        <p>Crear en la app <code>personnel</code> (TENANT_APP):</p>            <div class="code-block">                <code class="language-python"># personnel/models/system_user.pyfrom django.contrib.auth.models import Userfrom django.db import modelsimport uuidclass SystemUser(models.Model):    """Usuario del sistema (staff: admins, doctores, enfermeras, etc.)"""    id = models.UUIDField(primary_key=True, default=uuid.uuid4)        # Django User (auth)    user = models.OneToOneField(        User,        on_delete=models.CASCADE,        related_name='system_user'    )        # Relaci√≥n con Person (si el user es tambi√©n un Person/Doctor)    person = models.OneToOneField(        'personnel.Person',        null=True,        blank=True,        on_delete=models.SET_NULL,        related_name='system_user'    )        # Tipo de usuario    user_type = models.CharField(        max_length=100,        choices=[            ('admin', 'Administrador'),            ('doctor', 'M√©dico Ocupacional'),            ('nurse', 'Enfermera'),            ('operator', 'Operador'),            ('digitizer', 'Digitaci√≥n'),            ('auditor', 'Auditor'),        ]    )        # Settings personalizados    settings_json = models.JSONField(default=dict, blank=True)        # Control de acceso    is_approved = models.BooleanField(default=False)    is_blocked = models.BooleanField(default=False)    request_change_password = models.BooleanField(default=False)        # Migraci√≥n legacy    legacy_id = models.UUIDField(null=True, blank=True)        # Auditor√≠a    created_at = models.DateTimeField(auto_now_add=True)    updated_at = models.DateTimeField(auto_now=True)        class Meta:        db_table = 'personnel_system_user'        indexes = [            models.Index(fields=['user_type']),            models.Index(fields=['is_approved', 'is_blocked']),        ]</code>            </div>            <h3>4.2. Configuraci√≥n Multi-tenancy</h3>            <div class="code-block">                <code class="language-python"># config/settings.pySHARED_APPS = [    'django_tenants',    'tenants',    'utils',    'django.contrib.contenttypes',    'django.contrib.sessions',    'django.contrib.messages',    'django.contrib.admin',    'django.contrib.staticfiles',]TENANT_APPS = [    'django.contrib.auth',  # ‚Üê AUTH EN TENANT    'rest_framework',    'rest_framework_simplejwt',        'core',    'personnel',  # ‚Üê SystemUser aqu√≠    'forms',    'protocols',]</code>            </div>        </section>        <section id="backend">            <h2>5. Implementaci√≥n Backend</h2>            <h3>5.1. Instalaci√≥n de Dependencias</h3>            <div class="code-block">                <code class="language-bash">cd db_apipip install djangorestframework-simplejwt django-cors-headerspip freeze > requirements.txt</code>            </div>            <h3>5.2. Configuraci√≥n Django</h3>            <div class="code-block">                <code class="language-python"># config/settings.pyfrom datetime import timedeltaINSTALLED_APPS += [    'rest_framework',    'rest_framework_simplejwt',    'rest_framework_simplejwt.token_blacklist',    'corsheaders',]MIDDLEWARE = [    'corsheaders.middleware.CorsMiddleware',    'django_tenants.middleware.main.TenantMainMiddleware',    'django.middleware.security.SecurityMiddleware',    # ...]REST_FRAMEWORK = {    'DEFAULT_AUTHENTICATION_CLASSES': [        'rest_framework_simplejwt.authentication.JWTAuthentication',    ],}SIMPLE_JWT = {    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),    'ROTATE_REFRESH_TOKENS': True,    'BLACKLIST_AFTER_ROTATION': True,    'ALGORITHM': 'HS256',}CORS_ALLOWED_ORIGINS = [    "http://localhost:3000",    "https://*.anaprevention.com",]CORS_ALLOW_CREDENTIALS = True</code>            </div>            <h3>5.3. Endpoints de Autenticaci√≥n</h3>            <div class="code-block">                <code class="language-python"># personnel/endpoints/auth.pyfrom ninja import Routerfrom rest_framework_simplejwt.tokens import RefreshTokenfrom django.contrib.auth import authenticatefrom pydantic import BaseModelrouter = Router(tags=["Authentication"])class LoginSchema(BaseModel):    username: str    password: str@router.post("/login", response={200: dict, 401: dict}, auth=None)def login(request, payload: LoginSchema):    """Login con username/password ‚Üí retorna JWT"""        user = authenticate(        request,        username=payload.username,        password=payload.password    )        if not user:        return 401, {"error": "Credenciales inv√°lidas"}        system_user = user.system_user        if system_user.is_blocked:        return 403, {"error": "Usuario bloqueado"}        if not system_user.is_approved:        return 403, {"error": "Usuario pendiente de aprobaci√≥n"}        refresh = RefreshToken.for_user(user)        return {        "access": str(refresh.access_token),        "refresh": str(refresh),        "user": {            "id": str(system_user.id),            "username": user.username,            "email": user.email,            "user_type": system_user.user_type,        }    }@router.get("/me", auth=JWTAuth())def get_current_user(request):    """Obtiene info del usuario autenticado"""    system_user = request.user.system_user        return {        "id": str(system_user.id),        "username": request.user.username,        "email": request.user.email,        "user_type": system_user.user_type,        "is_approved": system_user.is_approved,    }</code>            </div>            <h3>5.4. Migrations</h3>            <div class="code-block">                <code class="language-bash">python manage.py makemigrations personnelpython manage.py migrate_schemas --sharedpython manage.py migrate_schemas</code>            </div>        </section>        <section id="frontend">            <h2>6. Implementaci√≥n Frontend</h2>            <h3>6.1. Django Auth Client</h3>            <div class="code-block">                <code class="language-typescript">// src/lib/auth/django-client.tsimport axios from 'axios';interface LoginCredentials {  username: string;  password: string;}class DjangoAuthClient {  private baseURL = process.env.NEXT_PUBLIC_DJANGO_API;  async login(credentials: LoginCredentials) {    const response = await axios.post(      `${this.baseURL}/api/personnel/auth/login`,      credentials    );        const { access, refresh, user } = response.data;    this.setTokens(access, refresh);    return { access, refresh, user };  }  async refresh() {    const refreshToken = this.getRefreshToken();    const response = await axios.post(      `${this.baseURL}/api/personnel/auth/refresh`,      { refresh: refreshToken }    );        const { access } = response.data;    this.setAccessToken(access);    return access;  }  private setTokens(access: string, refresh: string) {    localStorage.setItem('django_access_token', access);    localStorage.setItem('django_refresh_token', refresh);  }  getAccessToken() {    return localStorage.getItem('django_access_token');  }  private getRefreshToken() {    return localStorage.getItem('django_refresh_token');  }}export const djangoAuth = new DjangoAuthClient();</code>            </div>            <h3>6.2. API Client con Interceptores</h3>            <div class="code-block">                <code class="language-typescript">// src/lib/api-client.tsimport axios from 'axios';import { djangoAuth } from './auth/django-client';export const apiClient = axios.create({  baseURL: process.env.NEXT_PUBLIC_DJANGO_API,});// Request interceptor - agregar tokenapiClient.interceptors.request.use((config) => {  const token = djangoAuth.getAccessToken();  if (token) {    config.headers.Authorization = `Bearer ${token}`;  }  return config;});// Response interceptor - auto refreshapiClient.interceptors.response.use(  (response) => response,  async (error) => {    const originalRequest = error.config;    if (error.response?.status === 401 && !originalRequest._retry) {      originalRequest._retry = true;            try {        const newToken = await djangoAuth.refresh();        originalRequest.headers.Authorization = `Bearer ${newToken}`;        return apiClient(originalRequest);      } catch (refreshError) {        window.location.href = '/ingreso';        return Promise.reject(refreshError);      }    }    return Promise.reject(error);  });</code>            </div>            <h3>6.3. Auth Context</h3>            <div class="code-block">                <code class="language-typescript">// src/core/context/DjangoAuthContext.tsximport { createContext, useContext, useState, useEffect } from 'react';import { djangoAuth } from '@/lib/auth/django-client';interface AuthContextType {  user: User | null;  loading: boolean;  login: (username: string, password: string) => Promise<void>;  logout: () => Promise<void>;}const DjangoAuthContext = createContext<AuthContextType | undefined>(undefined);export function DjangoAuthProvider({ children }) {  const [user, setUser] = useState(null);  const [loading, setLoading] = useState(true);  useEffect(() => {    loadUser();  }, []);  async function loadUser() {    if (djangoAuth.isAuthenticated()) {      try {        const userData = await djangoAuth.getCurrentUser();        setUser(userData);      } catch (error) {        djangoAuth.clearTokens();      }    }    setLoading(false);  }  async function login(username: string, password: string) {    const response = await djangoAuth.login({ username, password });    setUser(response.user);  }  async function logout() {    await djangoAuth.logout();    setUser(null);  }  return (    <DjangoAuthContext.Provider value={{ user, loading, login, logout }}>      {children}    </DjangoAuthContext.Provider>  );}</code>            </div>        </section>        <section id="aws">            <h2>7. Deployment AWS</h2>            <h3>7.1. Arquitectura AWS</h3>            <pre><code>Internet    ‚ÜìRoute 53 (DNS)  *.anaprevention.com ‚Üí CloudFront    ‚ÜìCloudFront (CDN)  - Frontend (S3) para paths normales  - Backend (ALB) para /api/*    ‚ÜìApplication Load Balancer    ‚ÜìECS Fargate (Django x3)    ‚ÜìRDS PostgreSQL (Multi-schema)</code></pre>            <h3>7.2. Wildcard DNS</h3>            <div class="critical-box">                <strong>üîë Configuraci√≥n Clave:</strong> Wildcard DNS permite que nuevos subdominios funcionen autom√°ticamente sin tocar Route 53.            </div>            <div class="code-block">                <code class="language-bash"># Route 53 - Crear wildcard record (UNA SOLA VEZ)aws route53 change-resource-record-sets \  --hosted-zone-id Z1234567890ABC \  --change-batch '{    "Changes": [{      "Action": "CREATE",      "ResourceRecordSet": {        "Name": "*.anaprevention.com",        "Type": "A",        "AliasTarget": {          "HostedZoneId": "Z2FDTNDATAQYW2",          "DNSName": "d123.cloudfront.net",          "EvaluateTargetHealth": false        }      }    }]  }'</code>            </div>            <p><strong>Resultado:</strong> Todos los subdominios (<code>clinica-lima.anaprevention.com</code>, <code>minera-abc.anaprevention.com</code>, etc.) apuntan autom√°ticamente a CloudFront.</p>            <h3>7.3. SSL Wildcard Certificate</h3>            <div class="code-block">                <code>AWS Certificate Manager (ACM) - us-east-1Domain: *.anaprevention.comValidation: DNS (autom√°tico via Route 53)Cost: $0 (gratis con AWS)</code>            </div>            <h3>7.4. Onboarding Nuevo Cliente</h3>            <div class="success-box">                <strong>‚ú® Magia del Wildcard:</strong> Nuevos clientes funcionan INMEDIATAMENTE sin tocar AWS.            </div>            <ol>                <li><strong>Django crea Company:</strong> <code>Company.objects.create(schema_name='company_clinica_lima')</code></li>                <li><strong>Django crea Domain:</strong> <code>Domain.objects.create(domain='clinica-lima.anaprevention.com')</code></li>                <li><strong>Django crea schema PostgreSQL:</strong> Autom√°tico por django-tenants</li>                <li><strong>Django crea admin user:</strong> Usuario inicial del tenant</li>                <li><strong>¬°Listo!</strong> Cliente puede acceder inmediatamente</li>            </ol>            <p><strong>Tiempo total:</strong> ~10 segundos</p>            <p><strong>Trabajo manual:</strong> 0 (todo autom√°tico)</p>            <h3>7.5. Costos Estimados</h3>            <table>                <thead>                    <tr>                        <th>Servicio AWS</th>                        <th>Specs</th>                        <th>Costo/mes (50 tenants)</th>                    </tr>                </thead>                <tbody>                    <tr>                        <td>Route 53</td>                        <td>Hosted zone + queries</td>                        <td>$1</td>                    </tr>                    <tr>                        <td>ACM</td>                        <td>Certificado wildcard</td>                        <td>$0</td>                    </tr>                    <tr>                        <td>CloudFront</td>                        <td>1 TB transfer</td>                        <td>$85</td>                    </tr>                    <tr>                        <td>S3</td>                        <td>10 GB frontend</td>                        <td>$1</td>                    </tr>                    <tr>                        <td>ECS Fargate</td>                        <td>3 tasks (1 vCPU, 2 GB)</td>                        <td>$90</td>                    </tr>                    <tr>                        <td>ALB</td>                        <td>Load balancer</td>                        <td>$25</td>                    </tr>                    <tr>                        <td>RDS PostgreSQL</td>                        <td>db.t3.medium</td>                        <td>$60</td>                    </tr>                    <tr>                        <td><strong>TOTAL</strong></td>                        <td></td>                        <td><strong>~$262/mes</strong></td>                    </tr>                </tbody>            </table>            <p><strong>Costo por tenant:</strong> $262 / 50 = <strong class="highlight">$5.24/mes</strong></p>        </section>        <section id="validacion">            <h2>8. Validaci√≥n de Subdominios</h2>            <h3>8.1. Problema</h3>            <div class="warning-box">                <strong>‚ö†Ô∏è Issue:</strong> Con wildcard DNS, <strong>cualquier</strong> subdominio carga el frontend, incluso subdominios que no existen en la base de datos.            </div>            <p>Ejemplos problem√°ticos:</p>            <ul>                <li><code>aslkdnaslkd1.anaprevention.com</code> ‚Üí Cargar√≠a frontend ‚ùå</li>                <li><code>clinca-lima.anaprevention.com</code> (typo) ‚Üí Cargar√≠a frontend ‚ùå</li>                <li><code>hacker-test.anaprevention.com</code> ‚Üí Cargar√≠a frontend ‚ùå</li>            </ul>            <h3>8.2. Soluci√≥n: Validaci√≥n en Frontend al Cargar</h3>            <div class="success-box">                <strong>‚úÖ Approach:</strong> Frontend ejecuta "ping" al backend al cargar para validar que el subdomain existe.            </div>            <h4>Backend: Endpoint de Validaci√≥n</h4>            <div class="code-block">                <code class="language-python"># tenants/endpoints/validation.py@router.get("/validate", auth=None)def validate_tenant(request):    """Valida que el domain del request existe"""    hostname = request.get_host()        try:        domain = Domain.objects.get(domain=hostname)        tenant = domain.tenant                return {            'valid': True,            'tenant': {                'id': str(tenant.id),                'name': tenant.name,            }        }    except Domain.DoesNotExist:        # Buscar sugerencias (typo correction)        suggestions = get_domain_suggestions(hostname)                return JsonResponse({            'valid': False,            'error': 'domain_not_found',            'message': f'El dominio {hostname} no existe.',            'suggestions': suggestions        }, status=404)</code>            </div>            <h4>Frontend: Validator Component</h4>            <div class="code-block">                <code class="language-typescript">// src/components/TenantValidator.tsxexport function TenantValidator({ children }) {  const [status, setStatus] = useState('validating');  useEffect(() => {    validateTenant();  }, []);  async function validateTenant() {    try {      const response = await fetch('/api/tenants/validate');      const data = await response.json();      if (response.ok && data.valid) {        setStatus('valid');      } else {        setStatus('invalid');      }    } catch (error) {      setStatus('invalid');    }  }  if (status === 'validating') {    return <LoadingScreen />;  }  if (status === 'invalid') {    return <InvalidTenantScreen />;  }  return children;}</code>            </div>            <h3>8.3. Flujo de Validaci√≥n</h3>            <pre><code>1. Usuario accede: https://typo-error.anaprevention.com   ‚Üì2. CloudFront sirve frontend (HTML)   ‚Üì (~200ms)3. Frontend carga y ejecuta validaci√≥n   fetch('/api/tenants/validate')   ‚Üì4. Django valida: Domain.objects.get(domain=hostname)   ‚Üí NO EXISTE   ‚Üì5. Backend retorna 404 con sugerencias   ‚Üì6. Frontend muestra:   "üîç Organizaci√≥n no encontrada    ¬øQuisiste decir clinica-lima.anaprevention.com?"</code></pre>            <p><strong>Tiempo total:</strong> ~500ms</p>            <p><strong>UX:</strong> Error amigable con sugerencias inteligentes</p>        </section>        <section id="checklist">            <h2>9. Checklist de Implementaci√≥n</h2>            <h3>9.1. Backend (db_api)</h3>            <div class="code-block">                <code>[ ] 1. Instalar dependencias    pip install djangorestframework-simplejwt django-cors-headers[ ] 2. Configurar settings.py    - TENANT_APPS += ['django.contrib.auth']    - REST_FRAMEWORK authentication    - SIMPLE_JWT config    - CORS settings[ ] 3. Crear modelo SystemUser    - personnel/models/system_user.py    - Relaciones: User, Person    - Campos: user_type, is_approved, is_blocked[ ] 4. Crear endpoints de auth    - POST /api/personnel/auth/login    - GET /api/personnel/auth/me    - POST /api/personnel/auth/refresh[ ] 5. Crear endpoint de validaci√≥n    - GET /api/tenants/validate[ ] 6. Migrations    - makemigrations    - migrate_schemas[ ] 7. Script de migraci√≥n legacy    - management/commands/migrate_legacy_users.py[ ] 8. Testing    - Test login flow    - Test JWT refresh    - Test multi-tenancy isolation</code>            </div>            <h3>9.2. Frontend (ana-prevention-v2)</h3>            <div class="code-block">                <code>[ ] 1. Crear DjangoAuthClient    - src/lib/auth/django-client.ts    - M√©todos: login, refresh, logout[ ] 2. Crear API Client    - src/lib/api-client.ts    - Interceptores: request (token), response (refresh)[ ] 3. Crear AuthContext    - src/core/context/DjangoAuthContext.tsx    - Estado: user, loading    - Funciones: login, logout[ ] 4. Crear TenantValidator    - src/components/TenantValidator.tsx    - Validaci√≥n al cargar[ ] 5. Crear InvalidTenantScreen    - src/components/InvalidTenantScreen.tsx    - Mensaje de error + sugerencias[ ] 6. Integrar en layout    - src/app/layout.tsx    - Wrap con DjangoAuthProvider + TenantValidator[ ] 7. P√°gina de login    - src/app/ingreso/page.tsx    - Form + validaci√≥n[ ] 8. Eliminar Firebase    - Remover dependencias    - Limpiar c√≥digo Firebase Auth</code>            </div>            <h3>9.3. AWS Deployment</h3>            <div class="code-block">                <code>[ ] 1. Route 53    - Registrar dominio anaprevention.com    - Crear wildcard record: *.anaprevention.com[ ] 2. ACM    - Request certificado wildcard    - Validar con DNS[ ] 3. RDS PostgreSQL    - Crear instancia    - Configurar security groups[ ] 4. ECS + Docker    - Dockerizar Django    - Push a ECR    - Crear ECS cluster + service[ ] 5. ALB    - Crear load balancer    - Configurar target groups    - Listener HTTPS[ ] 6. S3 + CloudFront    - Build Next.js    - Upload a S3    - Crear CloudFront distribution    - Configurar origins (S3 + ALB)[ ] 7. Testing end-to-end    - Crear tenant de prueba    - Verificar subdominio funciona    - Test login + API calls</code>            </div>            <h3>9.4. Timeline Estimado</h3>            <table>                <thead>                    <tr>                        <th>Fase</th>                        <th>Tareas</th>                        <th>Tiempo</th>                        <th>Responsable</th>                    </tr>                </thead>                <tbody>                    <tr>                        <td><strong>Semana 1</strong></td>                        <td>Backend: Models, endpoints, JWT config</td>                        <td>3-4 d√≠as</td>                        <td>Backend Dev</td>                    </tr>                    <tr>                        <td><strong>Semana 1</strong></td>                        <td>Frontend: Auth client, context, UI</td>                        <td>3-4 d√≠as</td>                        <td>Frontend Dev</td>                    </tr>                    <tr>                        <td><strong>Semana 2</strong></td>                        <td>Migraci√≥n legacy users</td>                        <td>2 d√≠as</td>                        <td>Backend Dev</td>                    </tr>                    <tr>                        <td><strong>Semana 2</strong></td>                        <td>Validaci√≥n subdominios</td>                        <td>1 d√≠a</td>                        <td>Full Stack</td>                    </tr>                    <tr>                        <td><strong>Semana 2</strong></td>                        <td>Testing integraci√≥n</td>                        <td>2 d√≠as</td>                        <td>QA + Devs</td>                    </tr>                    <tr>                        <td><strong>Semana 3</strong></td>                        <td>AWS setup + deployment</td>                        <td>3-4 d√≠as</td>                        <td>DevOps</td>                    </tr>                    <tr>                        <td><strong>Semana 3</strong></td>                        <td>Testing producci√≥n</td>                        <td>1-2 d√≠as</td>                        <td>Todo el equipo</td>                    </tr>                </tbody>            </table>            <p><strong>Total estimado:</strong> <span class="highlight">3 semanas</span></p>        </section>        <section id="conclusiones">            <h2>10. Conclusiones y Pr√≥ximos Pasos</h2>            <h3>10.1. Resumen de Decisiones</h3>            <div class="success-box">                <ul style="margin: 0;">                    <li>‚úÖ <strong>Django Auth + JWT</strong> (rechazado Better Auth y Firebase)</li>                    <li>‚úÖ <strong>TENANT model</strong> (users en schema del tenant)</li>                    <li>‚úÖ <strong>Domain-based multi-tenancy</strong> (cada cliente su subdominio)</li>                    <li>‚úÖ <strong>Wildcard DNS</strong> (onboarding autom√°tico)</li>                    <li>‚úÖ <strong>Validaci√≥n frontend</strong> (ping al backend)</li>                </ul>            </div>            <h3>10.2. Ventajas de la Arquitectura</h3>            <ul>                <li><strong>Simple:</strong> Un solo sistema de auth (Django)</li>                <li><strong>Maduro:</strong> 18 a√±os de Django Auth en producci√≥n</li>                <li><strong>Seguro:</strong> Aislamiento total por tenant</li>                <li><strong>Escalable:</strong> Wildcard DNS soporta infinitos tenants</li>                <li><strong>Profesional:</strong> Cada cliente su dominio branded</li>                <li><strong>Econ√≥mico:</strong> ~$5/mes por tenant</li>                <li><strong>Compliance:</strong> HIPAA-ready, datos en tu infraestructura</li>            </ul>            <h3>10.3. Pr√≥ximos Pasos Inmediatos</h3>            <ol>                <li><strong>Semana 1:</strong> Implementar backend (models + endpoints + JWT)</li>                <li><strong>Semana 1:</strong> Implementar frontend (auth client + context + UI)</li>                <li><strong>Semana 2:</strong> Migrar usuarios legacy + validaci√≥n subdominios</li>                <li><strong>Semana 3:</strong> Deploy AWS + testing producci√≥n</li>            </ol>            <h3>10.4. Recursos</h3>            <ul>                <li><strong>Documentaci√≥n Django Auth:</strong> <a href="https://docs.djangoproject.com/en/5.0/topics/auth/">https://docs.djangoproject.com/en/5.0/topics/auth/</a></li>                <li><strong>Django Tenants:</strong> <a href="https://django-tenants.readthedocs.io/">https://django-tenants.readthedocs.io/</a></li>                <li><strong>SimpleJWT:</strong> <a href="https://django-rest-framework-simplejwt.readthedocs.io/">https://django-rest-framework-simplejwt.readthedocs.io/</a></li>                <li><strong>AWS CloudFront:</strong> <a href="https://docs.aws.amazon.com/cloudfront/">https://docs.aws.amazon.com/cloudfront/</a></li>            </ul>            <div class="info-box">                <strong>üìû Contacto:</strong> Para dudas o soporte durante la implementaci√≥n, contactar al equipo t√©cnico.            </div>        </section>        <footer style="margin-top: 60px; padding-top: 20px; border-top: 2px solid #e0e0e0; text-align: center; color: #666;">            <p><strong>Ana Prevention v2.0</strong> - Fase 0: Django Auth + Multi-tenancy</p>            <p>Generado: Febrero 2026 | <a href="https://claude.ai/claude-code" style="color: #28D196;">ü§ñ Creado con Claude Code</a></p>        </footer>    </div></body></html>